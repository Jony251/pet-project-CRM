generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  VIEWER
}

enum DealStatus {
  NEW
  CONTACTED
  PROPOSAL
  WON
  LOST
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

model User {
  id               String          @id @default(cuid())
  name             String
  email            String          @unique
  password         String
  role             Role            @default(VIEWER)
  assignedClients  Client[]        @relation("AssignedManager")
  dealsManaged     Deal[]          @relation("DealManager")
  dealComments     DealComment[]
  assignedTasks    Task[]          @relation("TaskAssignee")
  createdTasks     Task[]          @relation("TaskCreator")
  activities       ActivityLog[]
  interactions     Interaction[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([email, role])
}

model Client {
  id                String        @id @default(cuid())
  name              String
  email             String
  phone             String?
  company           String?
  source            String?
  assignedManagerId String?
  assignedManager   User?         @relation("AssignedManager", fields: [assignedManagerId], references: [id])
  deals             Deal[]
  interactions      Interaction[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([name, company])
  @@index([email])
  @@index([source])
  @@index([assignedManagerId])
}

model Interaction {
  id        String   @id @default(cuid())
  clientId  String
  userId    String
  type      String
  note      String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([clientId, createdAt])
}

model Deal {
  id        String        @id @default(cuid())
  title     String
  amount    Float
  status    DealStatus    @default(NEW)
  notes     String?
  clientId  String
  managerId String
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  manager   User          @relation("DealManager", fields: [managerId], references: [id], onDelete: Cascade)
  comments  DealComment[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([status])
  @@index([managerId, status])
  @@index([clientId])
}

model DealComment {
  id        String   @id @default(cuid())
  dealId    String
  userId    String
  comment   String
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([dealId, createdAt])
}

model Task {
  id             String     @id @default(cuid())
  title          String
  description    String?
  deadline       DateTime?
  status         TaskStatus @default(TODO)
  assignedUserId String
  createdById    String
  assignedUser   User       @relation("TaskAssignee", fields: [assignedUserId], references: [id], onDelete: Cascade)
  createdBy      User       @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([status, deadline])
  @@index([assignedUserId])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  metadata   Json?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  timestamp  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId, timestamp])
}
